<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Wednesday, December 09, 2015, 8:00 PM -->
<!-- MuClient version 4.93 -->

<!-- Plugin "Masaki_Bagger" generated by Plugin Wizard -->

<muclient>
<plugin
   name="Masaki_Bagger"
   author="BluMalice"
   id="d4ae4f5d7abcefffecf5c57a"
   language="Lua"
   purpose="Autoloots items into a bag instead of into the inventory."
   save_state="y"
   date_written="2015-12-09 19:59:35"
   requires="4.63"
   version="1.0"
   >

</plugin>


<!--  Get our standard constants -->

<include name="constants.lua"/>

<!--  Triggers  -->

<triggers>
<trigger
	match="^\{invmon\}(?<action>\d+)\,(?<id>\d+)\,.+\,.+$"
	enabled="y"
	regexp="y"
	omit_from_output="y"
	send_to="12"
	script="storeItem">
</trigger>
<trigger
	match="^\{invitem\}[\d]+\,.*\,.+\,[\d]+\,(?<type>[\d]+)\,[\d]+\,(?:-1|[d]+)\,(?:-1|[d]+)$"
	enabled="y"
	regexp="y"
	omit_from_output="y"
	sequence="100"
	send_to="12">
</trigger>
<trigger
	match="^\{invitem\}[\d]+\,.*\,.+\,[\d]+\,(?<type>13)\,[\d]+\,(?:-1|[d]+)\,(?:-1|[d]+)$"
	enabled="y"
	regexp="y"
	omit_from_output="y"
	sequence="95"
	send_to="12">
</trigger>
<trigger
	match="^You buy .+ from .+ for .+ gold\.$"
	enabled="y"
	regexp="y"
	sequence="95"
	send_to="12">
	<send>
		if string.find("%0", "You buy %d+ %*") then
			skipCount = tonumber(string.match("%0", "%d+"))
		end
		
		skip = true
	</send>
</trigger>
</triggers>

<!--  Aliases  -->

<aliases>
<alias
	match="^mba(?:g|gg|gge|gger) setbag (\d+)$"
	regexp="y"
	enabled="y"
	echo_alias="n"
	send_to="12"
	sequence="95">
	<send>
		vars.lootbag = "%1"
		ColourNote(vars.textForeground, vars.textBackground, centerText("Lootbag set to : " .. vars.lootbag, 62))
	</send>
</alias>
<alias
	match="^mba loot$"
	regexp="y"
	enabled="y"
	echo_alias="n"
	send_to="12"
	sequence="95">
	<send>
		vars.loot = not vars.loot
		ColourNote(vars.textForeground, vars.textBackground, centerText("Looting : " .. (vars.loot and "Yes" or "No"), 62))
	</send>
</alias>
<alias
	match="^mba(?:g|gg|gge|gger) help$"
	regexp="y"
	enabled="y"
	echo_alias="n"
	send_to="12"
	sequence="95"
	script="showHelp">
</alias>
</aliases>

<script>
<![CDATA[
--[[ ================================================================== 
     =                           INITIALIZE                           = 
     ================================================================== ]]
	 
require "serialize"

-- Default variables
vars = {}

-- Saved variables
vars.textBackground = "black"
vars.textForeground = "lime"
vars.lootbag = ""
vars.loot = true

function OnPluginInstall()
	-- Restore saved states
	assert(loadstring(GetVariable("vars") or ""))()
	vars = vars or {}
	vars.loot = vars.loot == nil and true or vars.loot
	
	ColourNote(vars.textForeground, vars.textBackground, ">>> ".. centerText("invmon must be on for Masaki Bagger to work.", 60) ..  " <<<")
	ColourNote(vars.textForeground, vars.textBackground, ">>> ".. centerText("Type invmon to turn it on if needed.", 60) ..  " <<<")

	-- Final touches to the loading sequence
	showHelp()
end

function OnPluginSaveState()
	SetVariable("vars", serialize.save("vars"))
end

function showHelp()
	ColourNote(vars.textForeground, vars.textBackground, "+------------------------{-=Masaki=-}------------------------+")
	ColourNote(vars.textForeground, vars.textBackground, "|".. centerText("", 60) ..  "|")
	ColourNote(vars.textForeground, vars.textBackground, "|".. centerText("*   mbagger setbag <bag_id>  *", 60) ..  "|")
	ColourNote(vars.textForeground, vars.textBackground, "|".. centerText("Sets the bag into which looted items will be stored.", 60) ..  "|")
	ColourNote(vars.textForeground, vars.textBackground, "|".. centerText("", 60) ..  "|")
	ColourNote(vars.textForeground, vars.textBackground, "|".. centerText("*   mbagger loot   *", 60) ..  "|")
	ColourNote(vars.textForeground, vars.textBackground, "|".. centerText("Toggles whether to loot or not.", 60) ..  "|")
	ColourNote(vars.textForeground, vars.textBackground, "|".. centerText("", 60) ..  "|")
	ColourNote(vars.textForeground, vars.textBackground, "|".. centerText("*   mbagger help   *", 60) ..  "|")
	ColourNote(vars.textForeground, vars.textBackground, "|".. centerText("Displays this message.", 60) ..  "|")
	ColourNote(vars.textForeground, vars.textBackground, "|".. centerText("", 60) ..  "|")
	ColourNote(vars.textForeground, vars.textBackground, "+------------------------{-=Masaki=-}------------------------+")
end

--[[ +----------------------------------------------------------------+ 
     |                       MISC UTILITIES                           | 
     +----------------------------------------------------------------+ ]]

function centerText(text, width)
	-- Wraps text into the center of the specified width.

	local length = width - #text
	if length > 0 then
		text = string.rep(" ", math.floor(length / 2)) .. text .. string.rep(" ", math.floor(length / 2))
	end
	
	return #text == width and text or text .. " "
end

--[[ ================================================================== 
     =                           OPERATIONS                           = 
     ================================================================== ]]
	 
function storeItem(name, line, wildcards, styles)
	-- Puts looted item into set lootbag
	
	if vars.lootbag == "" then
		ColourNote(vars.textForeground, vars.textBackground, centerText("Lootbag has not been set yet!", 62))
		ColourNote(vars.textForeground, vars.textBackground, centerText("Please set a lootbag by typing : mbagger setbag <bag_id>", 62))
	elseif wildcards.action == "4" and vars.lootbag ~= "" and vars.loot then
		SendNoEcho("put " .. wildcards.id .. " " .. vars.lootbag)
	end
end
]]>
</script>
</muclient>