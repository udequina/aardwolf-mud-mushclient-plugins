<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Thursday, June 08, 2017, 7:59 PM -->
<!-- MuClient version 4.84 -->

<!-- Plugin "Loqui_PK" generated by Plugin Wizard -->

<muclient>
<plugin
   name="Loqui_PK"
   author="Castiel"
   id="a70da94c1a51c67e361d50b1"
   language="Lua"
   purpose="PK broadcast"
   save_state="y"
   date_written="2017-06-08 19:58:48"
   requires="4.84"
   version="1.0"
   >
   <description trim="n">
   		<![CDATA[
.----------------------------------------------------------------------------.
| Loqui PK Help                                                              |
|----------------------------------------------------------------------------|
|lpk help -- Brings up the help section. (What you are reading now)          |
|                                                                            |
|lpk channel <channel> -- Automatically broadcast to this channel.           |
|lpk broadcast         -- Manually broadcast your location.                  |
|lpk go                -- Run to the last room seen on any channels.         |
'----------------------------------------------------------------------------'
]]>
</description>
</plugin>

<aliases>
  <alias regexp="y" match="^lpk help$" enabled="y" script="Help"></alias>
  <alias regexp="y" match="^lpk broadcast$" enabled="y" script="ManualBroadcast"></alias>
  <alias regexp="y" match="^lpk channel (.*)$" enabled="y" script="SetChannel"></alias>
  <alias regexp="y" match="^lpk go$" enabled="y" script="RuntoPK"></alias>
</aliases>

<triggers>
	<trigger regexp="y" match="^\*\* You can take revenge on (?<enemy>.*) for 15 minutes.$" enabled="y" sequence="100" script="AutoBroadcast"></trigger>
	<trigger regexp="y" match="^\*\* For his interference\, you can take revenge on (?<enemy>.*) for 15 minutes.$" enabled="y" sequence="100" script="AutoBroadcast"></trigger>
</triggers>

<!--  Get our standard constants -->

<include name="constants.lua"/>

<!--  Script  -->


<script>
<![CDATA[
	require "gmcphelper"

	local channel = (GetVariable("channel") or "clan")
	local currentArea = "None"
	local currentRoom = "None"
	local currentRoomID = -1
	local currentState = "Not Fighting"
	local currentEnemy = "None"
	local broadcastType = "Manual"
	local currentLevel = -1
	local currentHP = -1
	local maxHP = -1
	local pkgoRoom = -1

	function Help()
		ColourNote("orange", "black", GetPluginInfo (GetPluginID (), 3))
	end

	function ManualBroadcast()
		currentEnemy = "None"
		broadcastType = "Manual"
		BroadcastPVP()
	end

	function AutoBroadcast(name, line, wildcards)
		currentEnemy = wildcards.enemy
		broadcastType = "Revenge@C/@WAuto"
		BroadcastPVP()
	end

	function RuntoPK(name, line, wildcards)
		if pkgoRoom == -1 then
			ColourNote("orange", "", "You have not yet seen a pvp broadcast yet.")
			return
		end
		Execute("mapper goto " .. tostring(pkgoRoom))
	end

	function BroadcastPVP()
--***PVP ALERT*** Target:[Player/Revenge/Auto] Where:[solan/Park Lane/23729] My HP/Level:[14%/20/Fighting]'
		local tempString = channel .. " @c***@CPVP ALERT@c*** @cTarget:@C[@W" .. 
						currentEnemy .. "@C/@W" .. broadcastType .. "@C] @cWhere:@C[@W" ..
						currentArea .. "@C/@W" .. currentRoom .. "@C/@W" .. tostring(currentRoomID) .. "@C] @cMy HP/Level:@C[@W" .. 
						tostring(math.floor((tonumber(currentHP)/tonumber(maxHP))*100)) .. "%@C/@W" .. currentLevel .. "@C/@W" .. currentState .. "@C]"
		Send(tempString)
	end

	function SetChannel(name, line, wildcards)
		if wildcards[1] == "" or wildcards[1] == nil then
			ColourNote("orange", "", "Invalid channel.")
			return
		end

		channel = wildcards[1]
		SetVariable("channel", channel)
		ColourNote("orange", "", "Channel set to:" .. channel)
	end

	function OnPluginInstall()
		Send_GMCP_Packet("request char")
		Send_GMCP_Packet("request room")
	end

	function OnPluginBroadcast(msg, id, name, text)
		if (id == '3e7dedbe37e44942dd46d264') then
			if (text == "room.info") then
				res, gmcparg = CallPlugin("3e7dedbe37e44942dd46d264","gmcpval","room.info") --- We just want the room.info section.
				luastmt = "gmcpdata = " .. gmcparg --- Convert the serialized string back into a lua table.
				assert (loadstring (luastmt or "")) ()

				if (gmcpdata ~= nil) then
					currentArea = gmcpdata.zone
					currentRoom = gmcpdata.name
					currentRoomID = gmcpdata.num
				end
			elseif (text == "char.status") then
				res, gmcparg = CallPlugin("3e7dedbe37e44942dd46d264","gmcpval","char.status")				 
				luastmt = "gmcpdata = " .. gmcparg --- Convert the serialized string back into a lua table.
				assert (loadstring (luastmt or "")) ()																						

				if gmcpdata ~= nil and gmcpdata ~= "" then
					if tonumber(gmcpdata.state) == 8 then
						currentState = "Fighting"
					else
						currentState = "Not Fighting"
					end
					currentLevel = gmcpdata.level
				end
			elseif (text == "char.vitals") then
				res, gmcparg = CallPlugin("3e7dedbe37e44942dd46d264","gmcpval","char.vitals")				 
				luastmt = "gmcpdata = " .. gmcparg --- Convert the serialized string back into a lua table.
				assert (loadstring (luastmt or "")) ()		

				if gmcpdata ~= nil and gmcpdata ~= "" then
					currentHP = tonumber(gmcpdata.hp)
				end
			elseif (text == "char.maxstats") then
				res, gmcparg = CallPlugin("3e7dedbe37e44942dd46d264","gmcpval","char.maxstats")				 
				luastmt = "gmcpdata = " .. gmcparg --- Convert the serialized string back into a lua table.
				assert (loadstring (luastmt or "")) ()		

				if gmcpdata ~= nil and gmcpdata ~= "" then
					maxHP = tonumber(gmcpdata.maxhp)
				end
			elseif (text == "comm.channel") then
				res, gmcparg = CallPlugin("3e7dedbe37e44942dd46d264","gmcpval","comm.channel")				 
				luastmt = "gmcpdata = " .. gmcparg --- Convert the serialized string back into a lua table.
				assert (loadstring (luastmt or "")) ()		

				if gmcpdata ~= nil and gmcpdata ~= "" then
					local msg = gmcpdata.msg

					if string.find(msg, "PVP ALERT") ~= nil and string.find(msg, "Where:") ~= nil then --Found the plugin msg
						msg = string.gsub(msg, "@.", "")
						local bull, shit, rID = string.match(msg, "Where:%[(.-)/(.-)/(.-)%]")
						pkgoRoom = rID
					end
				end
	  		end
      		end
	end

]]>
</script>


</muclient>
