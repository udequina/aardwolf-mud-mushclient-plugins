<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Monday, August 20, 2018, 4:23 PM -->
<!-- MuClient version 5.06-pre -->

<!-- Plugin "Group_Password" generated by Plugin Wizard -->

<muclient>
<plugin
   name="Loqui_Group_Password"
   author="Crowley"
   id="6b4e6395536d0f2ad923f18e"
   language="Lua"
   purpose="Allows invitation by password"
   save_state="y"
   date_written="2018-08-20 16:22:28"
   requires="4.86"
   version="1.4"
   >

</plugin>
<triggers>
 <trigger
  match="^(\w+) is a member of another group\.$"
  enabled="y"
  regexp="y"
  keep_evaluating="y"
  sequence="100"
  script="onAlreadyGrouped"
 >
 </trigger>
</triggers>

<aliases>
 <alias
  match="gpw(?:\s([\w\d]+))?$"
  enabled="y"
  regexp="y"
  sequence="100"
  script="onPasswordChange"
 >
 </alias>
 <alias
  match="gwhite(?:\s(\w+))?$"
  enabled="y"
  regexp="y"
  sequence="100"
  script="whitelistChange"
 >
 </alias> 
</aliases>

<!--  Script  -->


<script>
<![CDATA[
-- Basic help
print()
print("~~~~~~~~~~~~~~~~~~~")
ColourNote("orange", "", "Loqui Group Password Manager " .. GetPluginInfo(GetPluginID(), 19) .. " - Written by Crowley")
print()
ColourNote("white", "", "Allows you to set a password. Whitelisted players can send a tell in the format of:\n\npassword <password> <invite|promote> <player>\n\nand if you are a leader, you will perform the action indicated.")
print()
ColourNote("cyan", "", "gpw <password>\n", "white", "", "With parameter, sets a new password, otherwise displays current password.")
print()
ColourNote("cyan", "", "gwhite <player>\n","white", "", "With parameter, toggles adding/removing players from the whitelist, otherwise displays who is whitelisted.")
print("~~~~~~~~~~~~~~~~~~~")
print()

-- Requires
require 'gmcphelper'
require 'serialize'

-- Variables
passwordSet         = GetVariable("passwordSet") or "default"
invited             = ""
gmcpID              = "3e7dedbe37e44942dd46d264"
commandtbl          = {"invite", "promote"}


assert(loadstring(GetVariable("whitelist") or ""))()

if not whitelist then whitelist = {"Crowley", "Anymouse", "Castiel", "Rauru", "Chewik", "Fertain"} end

-- Functions
function onPassword(player)
    local members, isGrouped = gmcp("group.members"), false, false

    for _,v in ipairs(members) do
        if v == player then
            isGrouped = true
            break
        end
    end

    if not isGrouped then
        Send("group invite " .. player)
        invited = player
    end
end

function ismember(set, key)
    local iskey = false
    for _,v in ipairs(set) do
        if v:upper() == key:upper() then
            iskey = true
            break
        end
    end
    return iskey
end

function whitelistChange(name, line, wildcards)
    local matchFound = false
    if wildcards[1] ~= "" then

        for i,v in ipairs(whitelist) do
            if v:upper() == wildcards[1]:upper() then
                matchFound = true
                table.remove(whitelist, i)
                break
            end
        end

        if matchFound then
            ColourNote("white", "blue", wildcards[1] .. " has been removed from the whitelist.")
        else
            table.insert(whitelist, wildcards[1])
            ColourNote("white", "blue", wildcards[1] .. " has been added to the whitelist.")
        end
        SetVariable("whitelist", serialize.save("whitelist"))
    else
        ColourNote("white", "blue", "The following people have been whitelisted:\n", "white", "", table.concat(whitelist, ", "))
    end
end


function onAlreadyGrouped(name, line, wildcards)
    if invited:upper() == wildcards[1]:upper() then
        Send("tell " .. wildcards[1] .. " You're already in a group. Please leave it and try again.")
    end
end

function strip_colours(s)
    s = s:gsub("@@", "\0")  -- change @@ to 0x00
    s = s:gsub("@%-", "~")    -- fix tildes (historical)
    s = s:gsub("@x%d?%d?%d?", "") -- strip valid and invalid xterm color codes
    s = s:gsub("@.([^@]*)", "%1") -- strip normal color codes and hidden garbage
    return (s:gsub("%z", "@")) -- put @ back (has parentheses on purpose)
end

function onPasswordChange(name, line, wildcards)
    local param = wildcards[1]
    if param ~= "" then
        passwordSet = wildcards[1]
        SetVariable("passwordSet", passwordSet)
        ColourNote("white", "blue", "Group password set to: " .. param)
    else
        ColourNote("white", "blue", "Current group password is: " .. passwordSet)
    end
end

function OnPluginBroadcast(msg, id, name, text)
    if (id == gmcpID) and (text == "comm.channel") then
        if gmcp("comm.channel.chan") == "tell" then
            local msg, player, msgtbl, leader = strip_colours(gmcp("comm.channel.msg")), gmcp("comm.channel.player"), {}, gmcp("group.leader")
            msg = msg:gsub("^.-" .. player .. " tells you '(.+)'$", "%1")

            if ismember(whitelist, player) then
                for word in msg:gmatch("%w+") do
                    table.insert(msgtbl, word)
                end
        
                if gmcp("char.base.name") == leader then
                    if msgtbl[1] == "password" or msgtbl[1] == "pw" then
                        if msgtbl[2] == passwordSet then
                            if msgtbl[3] then
                                if msgtbl[4] then
                                    for _,v in ipairs(commandtbl) do
                                        if v == msgtbl[3] then
                                            Send(string.format("group %s %s", msgtbl[3], msgtbl[4]))
                                            break
                                        end
                                    end
                                else
                                    Send(string.format("group %s %s", msgtbl[3], player))
                                end
                            else
                                onPassword(player)
                            end
                        end
                    end
                end
            end
        end
    end
end
]]>
</script>


</muclient>
