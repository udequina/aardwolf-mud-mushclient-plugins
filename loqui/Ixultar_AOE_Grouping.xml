<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Friday, March 04, 2016, 10:52 AM -->
<!-- MuClient version 4.99 -->

<!-- Plugin "Ixultar_AOE_Grouping" generated by Plugin Wizard -->

<muclient>
<plugin
   name="Ixultar_AOE_Grouping"
   author="Ixultar"
   id="191de8440f8b073ee6bae24a"
   language="Lua"
   purpose="Group area effect spells so they take up less space."
   save_state="y"
   date_written="2016-03-04 10:51:29"
   requires="4.73"
   version="1.0"
   >

</plugin>


<!--  Get our standard constants -->

<include name="constants.lua"/>

<!--  Triggers  -->

<triggers>
  <trigger
   enabled="y"
   match="^(\[(.*?)\] )?(?<name>.*?) (?<type>fiery rain|swing|toxic cloud|purging|fire breath|field of death|earthquake|flaming bolts of godly might|freezing sleet|ultrablast|God's Wrath|heavenly smiting|projected force|frenzied attack|brilliant arrow of light|EXPLOSION) (.*?) \[(?<amount>.*?)\]$"
   regexp="y"
   omit_from_output="y"
   send_to="12"
   sequence="100"
   script="TrackDamage"
  >
  </trigger>

  <trigger
   enabled="y"
   match="(.*?) has (.*?) charge(|s) remaining\."
   regexp="y"
   omit_from_output="n"
   send_to="12"
   sequence="100"
   script="DisplayRound"
  >
  </trigger>
  
  <trigger
   enabled="y"
   match="(.*?) implodes after its final use\."
   regexp="y"
   omit_from_output="n"
   send_to="12"
   sequence="100"
   script="DisplayRound"
  >
  </trigger>
  
</triggers>

<!--  Aliases  -->

<aliases>
  <alias
   match="aoet"
   enabled="y"
   send_to="12"
   sequence="100"
   script="Report"
  >
  </alias>
</aliases>

<include name="constants.lua"/>

<script>

<![CDATA[
local damages = {}

function OnPluginBroadcast (msg, id, name, text)
	-- Attempt to display a round whenever we get gmcp, which usually puts it in the right place
	DisplayRound() 
end

function TrackDamage(name, line, wildcards)
	-- Note("tracking")
	local amount = tonumber(wildcards.amount)
	
	local named_damage = damages[wildcards.name]
	if (named_damage == nil) then
		named_damage = {}
		damages[wildcards.name] = named_damage
	end
	
	if (named_damage[wildcards.type] == nil) then
		named_damage[wildcards.type] = {["amount"] = amount, ["hits"] = 1}
	else
		local d = named_damage[wildcards.type]
		d["amount"] = d["amount"] + amount
		d["hits"] = d["hits"] + 1
	end
end

function DisplayRound()
	for k, v in pairs(damages) do
		display(k, v)
	end
	
	clear(damages)
end

function display(name, individual_damages)
	for k, v in pairs(individual_damages) do
		local plural = ""
		if (v.hits > 1) then plural = "s" end
		
		color_text = "gainsboro"
		color_damage = "gainsboro"
		if (name == "Your") then
			color_text = "lime"
			color_damage = "red"
		end
		
		ColourNote(color_text, "", string.format("[%s] %s %s hits %s mob%s averaging %.0f damage. ", v.hits, name, k, v.hits, plural, v.amount / v.hits, v.amount),
			color_damage, "", string.format("[%s]", v.amount),
			"gainsboro", "", "")
	end	
end

function clear(t)
	for k in pairs (t) do
		t [k] = nil
	end
end

function Report()
	for k, v in pairs(damages) do
		Note(k .. " : " .. v.amount / v.hits)
	end
end

]]>
</script>

</muclient>
